--~ <select name=smashitem><option value=0>-select an item-</option><option cantransfer=1 candiscard=1 value=1903 descid='539713201'>4-ball (1)</option><option cantransfer=1 candiscard=1 value=362 descid='979636979'>7-Foot Dwarven mattock (1)</option><option cantransfer=1 candiscard=1 value=382 descid='185789106'>asbestos staff (1)</option><option cantransfer=1 candiscard=1 value=19 descid='889193761'>asparagus knife (1)</option><option cantransfer=1 candiscard=1 value=3865 descid='673197779'>black kettle drum (1)</option><option cantransfer=1 candiscard=1 value=3858 descid='151983382'>bone flute (1)</option><option cantransfer=0 candiscard=0 value=1249 descid='944109874'>Boss Bat britches (1)</option><option cantransfer=0 candiscard=0 value=1245 descid='711234565'>Cape of the Goblin King (1)</option><option cantransfer=1 candiscard=1 value=1921 descid='416618046'>cardboard wakizashi (3)</option><option cantransfer=1 candiscard=1 value=293 descid='547395764'>chef's hat (1)</option><option cantransfer=1 candiscard=1 value=1007 descid='330145487'>coconut shell (3)</option><option cantransfer=1 candiscard=1 value=10 descid='371973562'>disco ball (1)</option><option cantransfer=1 candiscard=1 value=9 descid='449052630'>disco mask (1)</option><option cantransfer=1 candiscard=1 value=632 descid='974234203'>disturbing fanfic (2)</option><option cantransfer=1 candiscard=1 value=4523 descid='134210242'>eye of the Tiger-lily (1)</option><option cantransfer=1 candiscard=1 value=224 descid='732809077'>eyepatch (1)</option><option cantransfer=1 candiscard=1 value=213 descid='404214724'>filthy corduroys (1)</option><option cantransfer=1 candiscard=1 value=214 descid='447628016'>filthy knitted dread sack (1)</option><option cantransfer=1 candiscard=1 value=3864 descid='143681765'>finger cymbals (1)</option><option cantransfer=1 candiscard=1 value=131 descid='805801465'>frilly skirt (1)</option><option cantransfer=1 candiscard=1 value=1151 descid='434938162'>giant discarded plastic fork (1)</option><option cantransfer=1 candiscard=1 value=619 descid='595147059'>giant needle (1)</option><option cantransfer=1 candiscard=1 value=1351 descid='202054250'>giant pinky ring (1)</option><option cantransfer=1 candiscard=1 value=703 descid='487916343'>goth kid t-shirt (1)</option><option cantransfer=1 candiscard=1 value=3 descid='447433823'>helmet turtle (1)</option><option cantransfer=1 candiscard=1 value=3847 descid='787966526'>hippy bongo (1)</option><option cantransfer=1 candiscard=1 value=4719 descid='464939729'>Hollandaise helmet (1)</option><option cantransfer=1 candiscard=1 value=4665 descid='276974436'>hot plate (1)</option><option cantransfer=1 candiscard=1 value=1756 descid='238982352'>huge spoon (1)</option><option cantransfer=1 candiscard=1 value=4666 descid='727568671'>imp unity ring (1)</option><option cantransfer=1 candiscard=1 value=4654 descid='131005788'>ironic battle spoon (1)</option><option cantransfer=1 candiscard=1 value=308 descid='316384894'>Knob Goblin elite helm (1)</option><option cantransfer=1 candiscard=1 value=309 descid='378095502'>Knob Goblin elite pants (1)</option><option cantransfer=1 candiscard=1 value=310 descid='239886636'>Knob Goblin elite polearm (1)</option><option cantransfer=1 candiscard=1 value=305 descid='382950400'>Knob Goblin harem pants (1)</option><option cantransfer=1 candiscard=1 value=306 descid='775258484'>Knob Goblin harem veil (1)</option><option cantransfer=1 candiscard=1 value=635 descid='635249410'>little paper umbrella (6)</option><option cantransfer=1 candiscard=1 value=1008 descid='145169884'>magical ice cubes (1)</option><option cantransfer=1 candiscard=1 value=4718 descid='318757613'>mariachi hat (1)</option><option cantransfer=1 candiscard=1 value=360 descid='825600819'>miner's helmet (2)</option><option cantransfer=1 candiscard=1 value=361 descid='984857229'>miner's pants (1)</option><option cantransfer=0 candiscard=0 value=4711 descid='548910318'>old sweatpants (1)</option><option cantransfer=1 candiscard=1 value=5 descid='249844320'>pasta spoon (1)</option><option cantransfer=1 candiscard=1 value=1793 descid='267780536'>pool cue (1)</option><option cantransfer=1 candiscard=1 value=6 descid='882973843'>ravioli hat (1)</option><option cantransfer=1 candiscard=1 value=50 descid='275331264'>Rock and Roll Legend (1)</option><option cantransfer=1 candiscard=1 value=1 descid='868780591'>seal-clubbing club (1)</option><option cantransfer=1 candiscard=1 value=2283 descid='700561477'>seal-skull helmet (1)</option><option cantransfer=1 candiscard=1 value=163 descid='247485062'>skeleton bone (4)</option><option cantransfer=1 candiscard=1 value=33 descid='135595861'>snorkel (1)</option><option cantransfer=0 candiscard=0 value=1225 descid='596081188'>stainless steel skullcap (1)</option><option cantransfer=1 candiscard=1 value=11 descid='199623005'>stolen accordion (1)</option><option cantransfer=1 candiscard=1 value=1977 descid='794493566'>stuffed frozen gravy fairy (1)</option><option cantransfer=1 candiscard=1 value=1982 descid='209068761'>stuffed MagiMechTech MicroMechaMech (1)</option><option cantransfer=1 candiscard=1 value=3948 descid='386950655'>stuffed Meat (1)</option><option cantransfer=1 candiscard=1 value=1986 descid='340187523'>stuffed mind flayer (1)</option><option cantransfer=1 candiscard=1 value=3953 descid='919228942'>stuffed mink (1)</option><option cantransfer=1 candiscard=1 value=3952 descid='687577413'>stuffed monocle (1)</option><option cantransfer=1 candiscard=1 value=1980 descid='332595258'>stuffed sleazy gravy fairy (1)</option><option cantransfer=0 candiscard=0 value=4181 descid='779768689'>sugar chapeau (1)</option><option cantransfer=1 candiscard=1 value=4 descid='164978098'>turtle totem (1)</option></select>

add_printer("/craft.php", function()
	if text:contains([[<select name=smashitem>]]) then
		groups = get_pulverize_groups()
		text = text:gsub([[(<select name=smashitem>)(.-)(</select>)]], function(preoptions, options, postoptions)
			optgroups = {}
			order = {}
			optgroups["Fake"] = {}
			table.insert(order, "Fake")
			for _, g in ipairs(groups) do
				optgroups[g.label] = {}
				table.insert(order, g.label)
			end
			optgroups["Unknown"] = {}
			table.insert(order, "Unknown")
			function place_item(id, opt)
				if id == 0 then
					table.insert(optgroups["Fake"], opt)
					return
				end
				for _, g in ipairs(groups) do
					if g.items[id] then
						table.insert(optgroups[g.label], opt)
						return
					end
				end
				table.insert(optgroups["Unknown"], opt)
			end
			for x, id, y in options:gmatch([[(<option[^>]-value=)([0-9]+)([^>]->[^<]-</option>)]]) do
				place_item(tonumber(id), x .. id .. y)
			end

			newoptions = ""
			for _, x in ipairs(order) do
				if table.maxn(optgroups[x]) > 0 then
					if x == "Fake" then
						newoptions = newoptions .. table.concat(optgroups[x])
					else
						newoptions = newoptions .. [[<optgroup label="]] .. x .. [[">]] .. table.concat(optgroups[x]) .. [[</optgroup>]]
					end
				end
			end

--~ 			print("options:", options)
			return preoptions .. newoptions .. postoptions
		end)
	end
end)
